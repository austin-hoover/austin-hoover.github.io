---
title: "High-dimensional phase space measurements"
date: 2023-05-28
author: Austin Hoover
categories: [accelerators, high-dimensional data, visualization]
bibliography: references.bib
csl: american-physics-society.csl
---


This post is a brief description of some work I've done during my postdoc at ORNL. Some of this work was recently published in Physical Review Accelerators and Beams (link).


## 1. Predicting intense beam dynamics

Linear accelerators (linacs) generate powerful ($\approx$ 1 megawatt (MW)) pulsed hadron beams for various applications. Significantly increasing the beam power/intensity would positively impact elementary particle physics, nuclear physics, condensed matter physics, biology, nuclear engineering, and other fields. Unfortunately, significantly increasing the beam intensity is not currently possible due to  *beam loss*, which occurs when particles hit the walls of the accelerator during their journey. The total lost beam power must not exceed 1 W per meter to avoid dangerous radiation levels. For a 1 MW beam, this limit corresponds to a fractional loss of $10^{-6}$.

Simulations struggle to predict the number and location of lost particles. Although the dynamics in the accelerator are complex, the physics is probably modeled correctly; the situation is perhaps unsurprising for other reasons:

1. Accelerators are composed of thousands of components distributed over hundreds of meters. Uncertainties in the position, alignment, amplitude, etc. of each component lead to errors in the applied electromagnetic field at each position.

2. The initial distribution of particles in position-momentum space (phase space) is usually unknown.

These issues make it difficult to predict the low-order moments of the beam distribution, let alone low levels of beam loss. The second issue is especially important because of the violent space charge forces that influence the beam evolution, coupling the output to the input phase space distribution.^[Space charge forces arise from the electric field generated by the beam. The strength of space charge forces scale inversely with the beam energy.]

Take the Spallation Neutron Source (SNS) as an example. The SNS accelerates negative hydrogen (H-) ions though a 500-meter linac. Hundreds of beam loss monitors (BLMs) record the total number of lost particles as a function of position --- the loss pattern --- in the linac, while limited measurements of the phase space distribution are available in the low-energy stages (near the boxed region). Simulations based on these measurements and the design accelerator parameters are not useful for predicting beam loss.

![Fig. ??. The Spallation Neutron Source (SNS) accelerator.](./figures/sns.png)


Important experimental work in this area came from the LEDA (Low Energy Test Accelerator) project at Los Alamos National Laboratory. One-dimensional (1D) density profiles of a low-energy proton beam were measured after a series of focusing quadrupole magnets. Simulations with various initial phase space distributions were compared to the measurements. The following figure is one example.

![Fig. ??. Vertical beam profile measured in the LEDA experiment \cite{}.](./figures/qiang_2002_fig9.png){width=450px fig-align=center}

The measured profile has a dense core surrounded by a low-density "halo" with a large spatial extent; none of the simulations correctly predicted the halo density. The simulations demonstrated that the halo is sensitive to the initial phase space distribution. This was expected since halo formation is thought to be driven by resonant particle interactions with the oscillating beam core.



## 2. High-dimensional phase space measurements


The SNS Beam Test Facility (BTF) is a recently comissioned test accelerator. The BTF is a replica of the front-end of the SNS linac followed by a 10-cell FODO line. We wish to repeat the LEDA experiments with vastly improved diagnostics. To this end, the BTF has pioneered high-dimensional phase space measurements to eliminate the uncertainty in the initial particle distribution, as well as high-dynamic-range phase space measurements to image the beam halo in two-dimensional phase space. We hope these measurements --- when combined with a detailed model of the accelerator and a well-tested simulation code --- will allow us to predict the beam evolution at the halo level in the BTF. This would be a first step toward beam loss prediction in a large-scale linear accelerator.


A diagram of the BTF is below:

![](./figures/btf.png)

The beam is composed of H- ions which are extracted from the plasma source and guided through the low-energy beam tranport (LEBT) using electrostatic focusing. After the LEBT, the beam is a slow-moving, continous stream of ions. The beam then passes through the radiofrequency quadrupole (RFQ), which provides focusing and acceleration up to 2.5 MeV. The beam is a train of small bunches after the RFQ. Each bunch drifts through the medium-energy beam transport (MEBT) and finally through a series of permanent quadrupole magnets aranged in a focusing-off-defocusing-off (FODO) pattern. (Halo formation would likely occur in the FODO line due to the rapid oscillation of the beam core.)

I'd like to focus on the measurement apparatus just after the RFQ. The purpose of this apparatus is to measure the particle density in phase space. The phase space is six-dimensional: three positions ($x$, $y$, $z$) and three momenta ($p_x$, $p_y$, $p_z$). The measurement works by measuring the charge within a small region of phase space $\mathbf{x} \pm \Delta$, where $\mathbf{x} = [x, p_x, y, p_y, z, p_z]^T$, with the $z$ axis is parallel to the beam. The density $f(\mathbf{x})$ is interpolated by scanning $\mathbf{x}$ through the phase space.

The region $\mathbf{x} \pm \Delta$ is selected using slits. First, a horizontal-vertical pair of slits selects a square in the $x$-$y$ plane. Next, a second pair of slits select $p_x$ and $p_y$ (based on the positions relative to the first slits). The momentum $p_z$ is selected by a vertical slit after a dipole magnet, which bends on-energy particles 90 degrees (faster particles bend more). The last to go is $z$: The beam passes through a wire, which generates an electron beam with the same time structure. Since the electrons are much less massive, they can be streaked in the transverse plane using an oscillating electric field. The streaking rotates the beam in the $x$-$z$ plane, so the image of the beam on a screen gives the $z$ distribution. 

![Fig. ??. Six-dimensional phase space measurement apparatus.](./figures/measurement.png){width=500px fig-align=center}

We perform the measurement by scanning the slits in a nested loop and recording the image of the beam on the screen at each setting. Each pixel in the image is (approximately) the intensity at a point in the phase space. By interpolating the data, we obtain an estimate of the phase space distribution $f(\mathbf{x})$. The first ever 6D measurement was reported in 2018: [link].

After the phase space distribution $f(\mathbf{x})$ is inferred, we generate a set of phase space coordinates $\{\mathbf{x}_1, \dots \mathbf{x}_n\}$ by sampling from the distribution. These coordinates are propagated through a computational model of the accelerator and compared with measurements at the end of the beamline. The BTF is equipped to measure $\{f(x, p_x), f(y, p_y)\}$ with high dynamic range at the end of the beamline. Our hope is that the predicted $\{f(x, p_x), f(y, p_y)\}$ agree with measurements even in low-density regions, four to six orders of magnitude below the peak density in the core. The entire workflow is illustrated below.

![](./figures/workflow.png){width=650px fig-align=center}



## 3. High-dimensional data visualization

Most of our time thus far has been spent analyzing the initial phase space distribution using high-dimensional measurements and comparing with RFQ simulations [\cite]. The rest of this post will describe some of our data processing and visualization.

### 3.1. Data acquisition

Our 6D measurements are quite slow at the moment and fail to capture very fine details in the distribution. Dropping one dimension ($z$) significantly increases the resolution and dynamic range while capturing most of the significant correlations in the data. Thus, 5D measurements are useful for in-depth examinations of the phase space distribution. We've gotten a lot of mileage out of a high-resolution 5D measurement I took in June 2022. The scan took 18 hours, generating over ???,??? images (??? GB). The image brightness, which changes as the slits move in and out of the beam core, is shown below.

![Fig. ??. Measured image brightness and beam current out of the RFQ during a 5D measurement.](./figures/bcm.png){width=500px}

The images were cropped and downscaled to decrease the size of the data set to around 36 GB. Next, the pixel intensities were interpolated onto a regular grid in 5D phase space, forming a $?? \times ?? \times ?? \times ??$ image.


### 3.2. Full projections


### 3.3. Slices

An interactive slicing widget using ipywidgets:

![](./figures/slicing.mov){width=600px fig-align=center}


![Fig. ??. A 4D slice of a measured 5D distribution.](./figures/slice_xp-yp_view_y-w.png)



### 3.4. Shell slices

![](./figures/shell_slice.png){width=450px fig-align=center}


## 4. What to make of these features?



## 5. Future work